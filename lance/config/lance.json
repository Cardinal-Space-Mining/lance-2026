{
    "pragma:enable_preproc": true,
    "pragma:import":
    [
        "perception.json",
        "tf.json"
    ],
    "pragma:constants":
    {
        "ARENA_FRAME_ID": "map",
        "ODOM_FRAME_ID": "odom",
        "ROBOT_FRAME_ID": "base_link",
        "LIDAR_FRAME_ID": "lidar_link",

        "LIDAR_HOSTNAME": "10.11.11.3",
        "ROBOT_HOSTNAME": "10.11.11.10",
        "CLIENT_HOSTNAME": "10.11.11.8",

        "LIDAR_SCAN_TOPIC": "/multiscan/lidar_scan",
        "LIDAR_IMU_TOPIC": "/multiscan/imu"
    },

    "preset":
    {
        "pragma:default": null,
        "motor_dev":
        {
            "pragma:action_overrides":
            {
                "joy_node": "xbox",
                "robot_status": "enabled",
                "robot_control": "enabled",
                "phoenix_motor_sim": "enabled",
                "robot_tf": "lance",
                "foxglove_bridge": "test"
            }
        },
        "gz_dev":
        {
            "pragma:action_overrides":
            {
                "joy_node": "xbox",
                "robot_status": "enabled",
                "robot_control": "enabled",
                "phoenix_motor_sim": "gz_sim",
                "perception": "test",
                "gz_sim": "motor_sim",
                "robot_tf": "lance",
                "foxglove_bridge": "test"
            }
        },
        "lidar_dev":
        {
            "pragma:action_overrides":
            {
                "multiscan_driver": "robot",
                "perception": "lidar_only",
                "pplan_client": "enabled",
                "foxglove_bride": "test",
                "foxglove_gui": "local"
            }
        },
        "lidar_bag":
        {
            "pragma:action_overrides":
            {
                "perception": "test",
                "pplan_client": "enabled",
                "robot_tf": "lance",
                "foxglove_bridge": "test",
                "foxglove_gui": "local"
            }
        }
    },

    "pplan_client":
    {
        "pragma:default": null,
        "enabled": {}
    },

    "multiscan_driver":
    {
        "pragma:default": null,
        "robot":
        {
            "pragma:node_options":
            {
                "remappings":
                {
                    "lidar_scan": "${ LIDAR_SCAN_TOPIC }",
                    "lidar_imu": "${ LIDAR_IMU_TOPIC }"
                }
            },

            "lidar_frame": "${ LIDAR_FRAME_ID }",
            "lidar_hostname": "${ LIDAR_HOSTNAME }",
            "lidar_udp_port": 2115,
            "sopas_tcp_port": 2111,
            "use_msgpack": false,
            "use_cola_binary": false,
            "udp_reset_timeout": 2.0,
            "udp_receive_timeout": 1.0,
            "sopas_read_timeout": 3.0,
            "error_restart_timeout": 3.0,
            "max_segment_buffers": 3,
            "echo_selection": 3
        },
        "debug":
        {
            "pragma:derived": "robot",
            "pragma:node_options":
            {
                "prefix": ["xterm -e gdb -ex run --args"]
            }
        }
    },



    "robot_control":
    {
        "pragma:default": null,
        "enabled":
        {
            "default_stick_deadzone": 0.05,
            "driving_magnitude_deadzone": 0.1,
            "driving_low_scalar": 0.3,
            "driving_medium_scalar": 0.7,
            "driving_high_scalar": 1.0,

            "trencher":
            {
                "max_velocity_rps": 80.0,
                "mining_velocity_rps": 80.0
            },

            "hopper_belt":
            {
                "max_velocity_rps": 45.0,
                "mining_velocity_rps": 10.0,
                "mining_duty_cycle_base_seconds": 1.0
            },

            "tracks":
            {
                "max_velocity_rps": 125.0,
                "mining_velocity_rps": 8.0,
                "mining_adjustment_range_rps": 6.0,
                "offload_velocity_rps": 30.0
            },

            "hopper_actuator":
            {
                "max_speed": 1.0,
                "plunge_speed": 0.4,
                "extract_speed": 0.8,
                "offload_target_val": 0.95,
                "traversal_target_val": 0.6,
                "transport_target_val": 0.55,
                "mining_target_val": 0.21,
                "mining_min_val": 0.03,
                "targetting_thresh": 0.01
            },

            "collection_model":
            {
                "initial_volume_liters": 0.6,
                "capacity_volume_liters": 25.0,
                "initial_belt_footprint_meters": 0.2,
                "belt_capacity_meters": 0.6,
                "belt_offload_length_meters": 0.7
            },

            "preset_mining_traversal_dist_meters": 0.25,
            "preset_offload_backup_dist_meters": 0.25,

            "iteration_period_seconds": 0.05,
            "odom_frame_id": "${ ODOM_FRAME_ID }",
            "arena_frame_id": "${ ARENA_FRAME_ID }",

            "auto_traversal":
            {
                "max_track_velocity_mps": 0.25,
                "max_angular_velocity_rps": 1.0,
                "max_acceleration_mpss": 0.5,
                "keypoint_thresh_m": 0.03,
                "max_path_deviation_m": 0.05
            },

            "mining_zone_bounds":
            {
                "min": [0.0, 0.0],
                "max": [2.5, 5.0]
            },
            "offload_zone_bounds":
            {
                "min": [4.53, 0.2],
                "max": [6.23, 1.0]
            }
        }
    },
    "phoenix5_driver":
    {
        "pragma:default": null,
        "enabled":
        {
            "diagnostics_port": 1250,
            "canbus": "can_phx5"
        }
    },
    "phoenix6_driver":
    {
        "pragma:default": null,
        "enabled":
        {
            "diagnostics_port": 0,
            "canbus": "can_phx6",
            "arduino_device": "",
            "power_cycle_fault_thresh_s": 1.5,
            "common":
            {
                "kP": 0.4,
                "kI": 0.05,
                "kD": 0.0001,
                "kV": 0.12,
                "neutral_deadband": 0.05,
                "neutral_brake": false,
                "stator_current_limit": 10.0,
                "supply_current_limit": 2.0,
                "voltage_limit": 12.0
            }
        }
    },
    "phoenix_motor_sim":
    {
        "pragma:default": null,
        "enabled":
        {
            "use_gz_track_feedback": false
        },
        "gz_sim":
        {
            "use_gz_track_feedback": true
        }
    },
    "robot_status":
    {
        "pragma:default": null,
        "enabled": {}
    },



    "redux":
    {
        "pragma:default": null,
        "robot":
        {
            "target": "robot",
            "client_hostname": "${ CLIENT_HOSTNAME }"
        },
        "client":
        {
            "target": "client",
            "robot_hostname": "${ ROBOT_HOSTNAME }",
            "lidar_frame_id": "${ LIDAR_FRAME_ID }",
            "pragma:node_options":
            {
                "remappings":
                {
                    "multiscan/imu": "redux/imu",
                    "multiscan/lidar_scan": "redux/lidar_scan"
                }
            }
        }
    },
    "robot_redux":
    {
        "pragma:default": null,
        "enabled":
        {

        }
    },
    "client_redux":
    {
        "pragma:default": null,
        "enabled":
        {

        }
    },



    "gz_sim":
    {
        "pragma:default": null,
        "enabled":
        {
            "robot": "lance"
        },
        "motor_sim":
        {
            "robot": "lance",
            "bridge_remappings":
            {
                "/joint_states": "/gz_joint_states"
            },
            "hid_control": false
        }
    },
    "gz_gui" :
    {
        "pragma:default": null,
        "enabled": {}
    },


    "foxglove_bridge":
    {
        "pragma:default": null,
        "test":
        {
            "port": 8765,
            "address": "0.0.0.0",
            "tls": false,
            "certfile": "",
            "keyfile": "",
            "topic_whitelist": [ ".*" ],
            "param_whitelist": [ ".*" ],
            "service_whitelist": [ ".*" ],
            "client_topic_whitelist": [ ".*" ],
            "min_qos_depth": 1,
            "max_qos_depth": 10,
            "num_threads": 4,
            "send_buffer_limit": 5000000000,
            "capabilities": [
                "clientPublish",
                "parameters",
                "parametersSubscribe",
                "services",
                "connectionGraph",
                "assets"
            ],
            "include_hidden": false,
            "asset_uri_allowlist": [
                "^package://(?:\\\\w+/)*\\\\w+\\\\.(?:dae|fbx|glb|gltf|jpeg|jpg|mtl|obj|png|stl|tif|tiff|urdf|webp|xacro)$"
            ]
        },
        "live":
        {
            "pragma:derived": "test",
            "topic_whitelist": [
                "/rosout",
                "/robot_description",
                "/tf.*",
                "/multiscan/.*",
                "/cardinal_perception/metrics/process_stats",
                "/cardinal_perception/metrics/scan_cb_stats",
                "/cardinal_perception/metrics/trav_cb_stats",
                "/cardinal_perception/metrics/mapping_cb_stats",
                "/cardinal_perception/gravity_estimation/*",
                "/cardinal_perception/filtered_scan",
                "/cardinal_perception/traversability_points",
                "/cardinal_perception/trav_interp_points",

                "/joy",

                "/lance/watchdog_status",
                "/lance/control_level",
                "/lance/mining_status",
                "/lance/offload_status",
                "/lance/relay_status",

                "/lance/track_left/ctrl",
                "/lance/track_left/faults",
                "/lance/track_left/info",
                "/lance/track_right/ctrl",
                "/lance/track_right/faults",
                "/lance/track_right/info",
                "/lance/trencher/ctrl",
                "/lance/trencher/faults",
                "/lance/trencher/info",
                "/lance/hopper_belt/ctrl",
                "/lance/hopper_belt/faults",
                "/lance/hopper_belt/info",
                "/lance/hopper_act/ctrl",
                "/lance/hopper_act/faults",
                "/lance/hopper_act/info",

                "/collection_state/is_full_volume",
                "/collection_state/is_full_occ",
                "/collection_state/volume",
                "/collection_state/mining_target",
                "/collection_state/offload_target",
                "/collection_state/belt_pos_m",
                "/collection_state/high_pos_m",
                "/collection_state/low_pos_m",
                "/collection_state/belt_usage_m"
            ],
            "send_buffer_limit": 10000000,
            "capabilities": [
                "clientPublish",
                "services",
                "connectionGraph",
                "assets"
            ]
        }
    },
    "foxglove_gui":
    {
        "pragma:default": null,
        "local":
        {
            "connection": "localhost:8765",
            "use_xdg": true
        },
        "mocha":
        {
            "connection": "mochapanda.local:8765",
            "use_xdg": true
        }
    },
    "joy_node":
    {
        "pragma:default": null,
        "xbox": {}
    },
    
    "bag_play":
    {
        "pragma:default": "lidar",
        "lidar":
        {
            "topics": [
                "/multiscan/lidar_scan",
                "/multiscan/imu"
            ],
            "start_paused": true,
            "loop": false,
            "remappings": {}
        },
        "lidar_with_tf":
        {
            "topics": [
                "/multiscan/lidar_scan",
                "/multiscan/imu",
                "/tf",
                "/tf_static"
            ]
        },
        "cosmic_bag":
        {
            "topics": [
                "/multiscan/lidar_scan",
                "/multiscan/imu",
                "/lance/watchdog_status",
                "/lance/control_level",
                "/lance/mining_status",
                "/lance/offload_status",
                "/lance/hopper_act/info",
                "/lance/hopper_belt/info",
                "/lance/track_left/info",
                "/lance/track_right/info",
                "/lance/trencher/info"
            ],
            "start_paused": true,
            "start_time": 359.0,
            "loop": false
        },
        "ksc_bag":
        {
            "topics": [
                "/multiscan/lidar_scan"
            ],
            "start_paused": true,
            "start_time": 250.0,
            "loop": false
        }
    },
    "bag_record":
    {
        "pragma:default": null,
        "all":
        {
            "output_prefix": "bag_recordings/lance_raw_data"
        },
        "sensor_data":
        {
            "output_prefix": "bag_recordings/lance_sensor_data",
            "topics": [
                "/multiscan/lidar_scan",
                "/multiscan/imu",
                "/tf",
                "/tf_static"
            ]
        },
        "telemetry":
        {
            "output_prefix": "bag_recordings/lance_telemetry",
            "topics": [
                "/joy",
                "/lance/watchdog_status",
                "/lance/control_level",
                "/lance/mining_status",
                "/lance/offload_status",
                "/lance/relay_status",

                "/lance/track_left/ctrl",
                "/lance/track_left/faults",
                "/lance/track_left/info",

                "/lance/track_right/ctrl",
                "/lance/track_right/faults",
                "/lance/track_right/info",

                "/lance/trencher/ctrl",
                "/lance/trencher/faults",
                "/lance/trencher/info",

                "/lance/hopper_belt/ctrl",
                "/lance/hopper_belt/faults",
                "/lance/hopper_belt/info",

                "/lance/hopper_act/ctrl",
                "/lance/hopper_act/faults",
                "/lance/hopper_act/info",

                "/collection_state/is_full_volume",
                "/collection_state/is_full_occ",
                "/collection_state/volume",
                "/collection_state/mining_target",
                "/collection_state/offload_target",
                "/collection_state/belt_pos_m",
                "/collection_state/high_pos_m",
                "/collection_state/low_pos_m",
                "/collection_state/belt_usage_m",

                "/rosout"
            ]
        }
    }
}
